package gg.valed.cef.listener;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import org.bukkit.plugin.Plugin;

import java.util.Stack;

public class AutoCompleteListener extends PacketAdapter {

    public AutoCompleteListener(Plugin plugin) {
        super(plugin, ListenerPriority.LOWEST, PacketType.Play.Client.TAB_COMPLETE);
    }

    @Override
    public void onPacketReceiving(PacketEvent event) {
        final String sentence = event.getPacket().getStrings().read(0);

        for (String word : sentence.split(" ")) {
            if (hasImbalance(word)) {
                event.setCancelled(true);
                return;
            }
        }
    }

    @Override
    public void onPacketSending(PacketEvent event) {
        // empty because we never send this
    }

    // imbalance = bad
    private boolean hasImbalance(String word) {
        // first we read through the word and remove any strings
        final String[] parts = word.split("\"");

        // detect invalid number of string quotes
        if (parts.length % 2 == 0) {
            return true;
        }

        final StringBuilder builder = new StringBuilder(word.length());
        for (int i = 0; i < parts.length; i += 2) {
            builder.append(parts[i]);
        }

        final Stack<Character> stack = new Stack<>();
        for (char c : builder.toString().toCharArray()) {
            switch (c) {
                case '[', '{' -> stack.push(c);
                case ']' -> {
                    if (!expectStack(stack, '[')) {
                        return true;
                    }
                }
                case '}' -> {
                    if (!expectStack(stack, '}')) {
                        return true;
                    }
                }
            }
        }

        return false;
    }

    // returns true if expected is found
    private boolean expectStack(Stack<Character> stack, char c) {
        final Character maybeC = stack.pop();
        if (maybeC == null) {
            return false;
        }

        return maybeC == c;
    }

}
